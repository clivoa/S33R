<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S33R Archive – Year Overview</title>

  <link rel="stylesheet" href="styles.css" />

  <style>
    .overview-container {
      max-width: 980px;
      margin: 0 auto;
      padding: 32px 12px 40px;
      text-align: center;
    }

    .overview-title {
      font-size: 30px;
      font-weight: 800;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    .overview-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 18px;
    }

    .overview-controls {
      display: flex;
      justify-content: center;
      margin-bottom: 18px;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .overview-controls select {
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 6px 10px;
      border-radius: var(--radius);
      font-size: 14px;
      min-width: 110px;
    }

    .overview-controls button {
      background: var(--accent);
      border: none;
      color: #0b0c10;
      padding: 6px 10px;
      border-radius: var(--radius);
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
    }

    .overview-controls button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .overview-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      text-align: left;
    }

    @media (min-width: 900px) {
      .overview-grid {
        grid-template-columns: 1.1fr 0.9fr;
      }
    }

    .overview-card {
      background: var(--bg-elevated);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      padding: 18px 20px 16px;
    }

    .overview-card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .overview-meta {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
      line-height: 1.5;
    }

    .overview-meta b {
      color: var(--text-primary);
    }

    .overview-list,
    .overview-list-full {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
      padding-left: 18px;
    }

    .overview-list li,
    .overview-list-full li {
      margin-bottom: 2px;
    }

    .sources-toggle-btn {
      margin-top: 6px;
      font-size: 11px;
      background: transparent;
      border: none;
      color: var(--accent);
      cursor: pointer;
      padding: 0;
    }

    canvas {
      width: 100%;
      height: 260px;
    }

    @media (max-width: 640px) {
      .overview-container {
        padding-top: 40px;
      }
    }

    /* Tooltip for charts */
    #chart-tooltip {
      position: absolute;
      padding: 4px 8px;
      font-size: 11px;
      background: rgba(0, 0, 0, 0.9);
      color: #f8f8f2;
      border-radius: 6px;
      pointer-events: none;
      display: none;
      z-index: 50;
      border: 1px solid rgba(255, 255, 255, 0.12);
      white-space: nowrap;
    }
  </style>
</head>
<body>

  <!-- Minimal Navbar -->
  <div class="minimal-navbar">
    <a href="index.html" class="minimal-nav-link">News</a>

    <div class="minimal-dropdown">
      <span class="minimal-nav-link dropdown-toggle">Archive ▾</span>
      <div class="dropdown-menu">
        <a href="archive.html">Archive List</a>
        <a href="archive-overview.html">Year Overview</a>
      </div>
    </div>
  </div>

  <div class="overview-container">
    <h1 class="overview-title">S33R Archive – Year Overview</h1>
    <p class="overview-subtitle">
      Visual summary of archived security news per year: activity per month and top sources.
    </p>

    <div class="overview-controls">
      <button id="prev-year-btn" title="Previous year">←</button>
      <select id="year-select">
        <option value="">Select year...</option>
      </select>
      <button id="next-year-btn" title="Next year">→</button>
    </div>

    <div id="overview-meta" class="overview-meta"></div>

    <div class="overview-grid">
      <div class="overview-card">
        <div class="overview-card-title">Items per month</div>
        <canvas id="monthly-chart" width="450" height="260"></canvas>
      </div>

      <div class="overview-card">
        <div class="overview-card-title">Top sources in year</div>
        <canvas id="sources-chart" width="450" height="260"></canvas>
        <ul id="sources-list" class="overview-list"></ul>
        <button id="toggle-sources" class="sources-toggle-btn" type="button">
          Show full list ▼
        </button>
        <ul id="sources-list-full" class="overview-list-full" style="display:none;"></ul>
      </div>
    </div>
    <footer class="site-footer">
      <p>
        S33R Security News Feed<br>
        <span class="muted">Powered by JSON cache + public RSS sources</span>
      </p>
    </footer>
  </div>

  <!-- Tooltip -->
  <div id="chart-tooltip"></div>

  <script>
    const candidateYears = [2023, 2024, 2025, 2026, 2027];
    const monthLabelsShort = ["J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D"];
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    const yearCache = {};
    let currentYear = null;
    let availableYears = [];
    let monthlyCountsForTooltip = [];
    const tooltipEl = document.getElementById("chart-tooltip");

    const monthlyCanvas = document.getElementById("monthly-chart");
    const sourcesCanvas = document.getElementById("sources-chart");

    const prevYearBtn = document.getElementById("prev-year-btn");
    const nextYearBtn = document.getElementById("next-year-btn");

    async function fetchJSON(path) {
      try {
        const res = await fetch(path);
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      }
    }

    async function loadYears() {
      const select = document.getElementById("year-select");
      let latest = null;

      for (const y of candidateYears) {
        const data = await fetchJSON(`data/archive/yearly/${y}.json`);
        if (Array.isArray(data) && data.length > 0) {
          yearCache[y] = data;
          availableYears.push(y);

          const opt = document.createElement("option");
          opt.value = y;
          opt.textContent = y;
          select.appendChild(opt);
          latest = y;
        }
      }

      if (latest) {
        select.value = latest;
        currentYear = latest;
        updateYearButtons();
        updateYearOverview(latest);
      } else {
        updateYearButtons();
      }
    }

    function extractYearStats(items) {
      const monthlyCounts = Array(12).fill(0);
      const sourceCounts = {};
      let minTs = Infinity;
      let maxTs = -Infinity;

      items.forEach(item => {
        let date = null;
        if (typeof item.published_ts === "number") {
          date = new Date(item.published_ts * 1000);
        } else if (item.published) {
          const d = new Date(item.published);
          if (!isNaN(d.getTime())) date = d;
        }
        if (!date) return;

        const m = date.getMonth(); // 0-11
        monthlyCounts[m] += 1;

        const src = item.source || "Unknown";
        sourceCounts[src] = (sourceCounts[src] || 0) + 1;

        const ts = date.getTime();
        if (ts < minTs) minTs = ts;
        if (ts > maxTs) maxTs = ts;
      });

      const topSources = Object.entries(sourceCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 7);

      const rangeStart = isFinite(minTs) ? new Date(minTs).toLocaleString() : "Unknown";
      const rangeEnd = isFinite(maxTs) ? new Date(maxTs).toLocaleString() : "Unknown";

      return {
        monthlyCounts,
        sourceCounts,
        topSources,
        totalItems: items.length,
        totalSources: Object.keys(sourceCounts).length,
        rangeStart,
        rangeEnd
      };
    }

    // ---------- Canvas helpers ----------

    function clearCanvas(canvas) {
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function drawMonthlyChart(canvas, counts) {
      const ctx = canvas.getContext("2d");
      clearCanvas(canvas);

      const labels = monthLabelsShort;
      const padding = { top: 20, right: 16, bottom: 26, left: 26 };
      const w = canvas.width;
      const h = canvas.height;
      const chartW = w - padding.left - padding.right;
      const chartH = h - padding.top - padding.bottom;

      const maxVal = Math.max(1, Math.max(...counts));
      const slotWidth = chartW / counts.length;
      const barWidth = slotWidth * 0.6;
      const gap = slotWidth * 0.4;

      ctx.font = "11px system-ui, -apple-system, BlinkMacSystemFont, sans-serif";
      ctx.fillStyle = "#888";

      // Y axis labels (0, max)
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      ctx.fillText("0", padding.left - 4, h - padding.bottom);
      ctx.fillText(String(maxVal), padding.left - 4, padding.top);

      // X axis labels + bars
      counts.forEach((val, i) => {
        const x = padding.left + i * slotWidth + gap * 0.2;
        const barHeight = chartH * (val / maxVal);
        const y = padding.top + (chartH - barHeight);

        // bar gradient
        const grad = ctx.createLinearGradient(0, y, 0, y + barHeight);
        grad.addColorStop(0, "#ff79c6");
        grad.addColorStop(1, "#bd93f9");
        ctx.fillStyle = grad;
        ctx.fillRect(x, y, barWidth, barHeight);

        // x label
        ctx.fillStyle = "#888";
        ctx.textAlign = "center";
        ctx.textBaseline = "top";
        const labelX = x + barWidth / 2;
        const labelY = h - padding.bottom + 4;
        ctx.fillText(labels[i], labelX, labelY);
      });

      // axes
      ctx.strokeStyle = "#444";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padding.left, padding.top);
      ctx.lineTo(padding.left, h - padding.bottom);
      ctx.lineTo(w - padding.right, h - padding.bottom);
      ctx.stroke();
    }

    function drawSourcesChart(canvas, topSources) {
      const ctx = canvas.getContext("2d");
      clearCanvas(canvas);

      if (!topSources || topSources.length === 0) return;

      const padding = { top: 14, right: 10, bottom: 14, left: 80 };
      const w = canvas.width;
      const h = canvas.height;
      const chartW = w - padding.left - padding.right;
      const chartH = h - padding.top - padding.bottom;

      const maxVal = Math.max(...topSources.map(s => s[1]));
      const rowHeight = chartH / topSources.length;

      ctx.font = "11px system-ui, -apple-system, BlinkMacSystemFont, sans-serif";
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "#888";

      topSources.forEach((entry, idx) => {
        const [src, count] = entry;
        const yCenter = padding.top + rowHeight * idx + rowHeight / 2;

        // label
        ctx.fillText(src, padding.left - 6, yCenter);

        // bar
        const width = chartW * (count / maxVal);
        const x = padding.left;
        const y = yCenter - 6;

        const grad = ctx.createLinearGradient(x, 0, x + width, 0);
        grad.addColorStop(0, "#8be9fd");
        grad.addColorStop(1, "#50fa7b");
        ctx.fillStyle = grad;
        ctx.fillRect(x, y, width, 12);

        // count
        ctx.fillStyle = "#bbb";
        ctx.textAlign = "left";
        ctx.fillText(String(count), x + width + 4, yCenter);
        ctx.fillStyle = "#888";
        ctx.textAlign = "right";
      });
    }

    function renderOverviewMeta(year, stats) {
      const metaEl = document.getElementById("overview-meta");
      if (!stats || stats.totalItems === 0) {
        metaEl.textContent = "";
        return;
      }

      const avg = Math.round(stats.totalItems / 12);
      const maxMonthIdx = stats.monthlyCounts.indexOf(Math.max(...stats.monthlyCounts));
      const mostActiveMonth = maxMonthIdx >= 0 ? monthNames[maxMonthIdx] : "N/A";

      metaEl.innerHTML =
        `Year <b>${year}</b>: ${stats.totalItems} items, ` +
        `${stats.totalSources} sources, avg <b>${avg}</b> items/month<br>` +
        `Most active month: <b>${mostActiveMonth}</b><br>` +
        `Data range: ${stats.rangeStart} → ${stats.rangeEnd}`;
    }

    function renderSourcesList(topSources) {
      const ul = document.getElementById("sources-list");
      ul.innerHTML = "";
      if (!topSources || topSources.length === 0) return;
      topSources.forEach(([src, count]) => {
        const li = document.createElement("li");
        li.textContent = `${src}: ${count}`;
        ul.appendChild(li);
      });
    }

    function renderFullSourceList(sourceCounts) {
      const ul = document.getElementById("sources-list-full");
      ul.innerHTML = "";
      if (!sourceCounts || Object.keys(sourceCounts).length === 0) return;

      Object.entries(sourceCounts)
        .sort((a, b) => b[1] - a[1])
        .forEach(([src, count]) => {
          const li = document.createElement("li");
          li.textContent = `${src}: ${count}`;
          ul.appendChild(li);
        });
    }

    async function updateYearOverview(year) {
      const canvasMonthly = monthlyCanvas;
      const canvasSources = sourcesCanvas;
      clearCanvas(canvasMonthly);
      clearCanvas(canvasSources);
      document.getElementById("sources-list").innerHTML = "";
      document.getElementById("sources-list-full").innerHTML = "";
      document.getElementById("overview-meta").textContent = "";

      if (!year) return;

      let data = yearCache[year];
      if (!data) {
        data = await fetchJSON(`data/archive/yearly/${year}.json`);
        if (Array.isArray(data)) {
          yearCache[year] = data;
        }
      }

      if (!Array.isArray(data) || data.length === 0) {
        document.getElementById("overview-meta").textContent = "No data for this year.";
        return;
      }

      const stats = extractYearStats(data);

      // save monthly counts for tooltip calc
      monthlyCountsForTooltip = stats.monthlyCounts.slice();

      drawMonthlyChart(canvasMonthly, stats.monthlyCounts);
      drawSourcesChart(canvasSources, stats.topSources);
      renderOverviewMeta(year, stats);
      renderSourcesList(stats.topSources);
      renderFullSourceList(stats.sourceCounts);
    }

    function updateYearButtons() {
      if (!currentYear || availableYears.length === 0) {
        prevYearBtn.disabled = true;
        nextYearBtn.disabled = true;
        return;
      }
      const idx = availableYears.indexOf(Number(currentYear));
      prevYearBtn.disabled = idx <= 0;
      nextYearBtn.disabled = idx === -1 || idx >= availableYears.length - 1;
    }

    document.getElementById("year-select").addEventListener("change", (e) => {
      const y = e.target.value;
      currentYear = y || null;
      updateYearButtons();
      if (!currentYear) {
        document.getElementById("overview-meta").textContent = "";
        clearCanvas(monthlyCanvas);
        clearCanvas(sourcesCanvas);
        document.getElementById("sources-list").innerHTML = "";
        document.getElementById("sources-list-full").innerHTML = "";
        return;
      }
      updateYearOverview(currentYear);
    });

    prevYearBtn.addEventListener("click", () => {
      if (!currentYear) return;
      const idx = availableYears.indexOf(Number(currentYear));
      if (idx > 0) {
        const prev = availableYears[idx - 1];
        currentYear = prev;
        document.getElementById("year-select").value = prev;
        updateYearButtons();
        updateYearOverview(prev);
      }
    });

    nextYearBtn.addEventListener("click", () => {
      if (!currentYear) return;
      const idx = availableYears.indexOf(Number(currentYear));
      if (idx !== -1 && idx < availableYears.length - 1) {
        const next = availableYears[idx + 1];
        currentYear = next;
        document.getElementById("year-select").value = next;
        updateYearButtons();
        updateYearOverview(next);
      }
    });

    // Toggle full sources list
    document.getElementById("toggle-sources").addEventListener("click", () => {
      const full = document.getElementById("sources-list-full");
      const btn = document.getElementById("toggle-sources");
      if (full.style.display === "none" || full.style.display === "") {
        full.style.display = "block";
        btn.textContent = "Hide full list ▲";
      } else {
        full.style.display = "none";
        btn.textContent = "Show full list ▼";
      }
    });

    // Tooltip for monthly chart
    monthlyCanvas.addEventListener("mousemove", (e) => {
      if (!monthlyCountsForTooltip || monthlyCountsForTooltip.length === 0) {
        tooltipEl.style.display = "none";
        return;
      }

      const rect = monthlyCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const padding = { top: 20, right: 16, bottom: 26, left: 26 };
      const w = monthlyCanvas.width;
      const h = monthlyCanvas.height;
      const chartW = w - padding.left - padding.right;
      const chartH = h - padding.top - padding.bottom;
      const slotWidth = chartW / monthlyCountsForTooltip.length;
      const barWidth = slotWidth * 0.6;
      const gap = slotWidth * 0.4;

      if (x < padding.left || x > w - padding.right || y < padding.top || y > h - padding.bottom) {
        tooltipEl.style.display = "none";
        return;
      }

      const idx = Math.floor((x - padding.left) / slotWidth);
      if (idx < 0 || idx >= monthlyCountsForTooltip.length) {
        tooltipEl.style.display = "none";
        return;
      }

      const count = monthlyCountsForTooltip[idx];
      const label = monthNames[idx];
      tooltipEl.style.display = "block";
      tooltipEl.textContent = `${label}: ${count} items`;
      tooltipEl.style.left = (e.pageX + 12) + "px";
      tooltipEl.style.top = (e.pageY + 12) + "px";
    });

    monthlyCanvas.addEventListener("mouseleave", () => {
      tooltipEl.style.display = "none";
    });

    loadYears();
  </script>

</body>
</html>
